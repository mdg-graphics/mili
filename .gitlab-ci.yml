workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule" || $CI_PIPELINE_SOURCE == "web"
      when: always
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TITLE =~ /^(\[Draft\]|\(Draft\)|Draft:)/
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TITLE =~ /^(\[Doc\]|\(Doc\)|Doc:)/
      when: never
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
    - if: $CI_COMMIT_BRANCH == "master" && $CI_PIPELINE_SOURCE != "merge_request_event"
      when: always  # Runs tests when changes are committed to master
    - when: never

stages:
  - test

variables:
  GIT_SUBMODULE_STRATEGY: normal

.slurm-defaults:
  variables:
    NNODES: 1
    NPROCS: 16
    QUEUE: pdebug
    INTEG_WALL_TIME: 5

.slurm:
  variables:
    LLNL_SLURM_SCHEDULER_PARAMETERS: "-N $NNODES -n $NPROCS -p $QUEUE -t $INTEG_WALL_TIME"

.build-mili-xmilics:
  variables:
    BUILD_SPEC: ${SYS_TYPE}-${COMPILER_SPEC}
  script:
    - configure.py
    - cd build-${BUILD_SPEC}-relwithdebinfo
    - make -j
    - cd -

.run-tests:
  script:
    - cd test/
    - mdgtest/Test.py -e mililib_env -c ../build-${BUILD_SPEC}-relwithdebinfo/lib -I ../build-${BUILD_SPEC}-relwithdebinfo/include -n1 -p1 -s all > test_mili.out
    - num_mili_failed=$( grep -c -e failed -e "did not run correctly" test_mili.out ) || true
    - mdgtest/Test.py -e xmilics_env -c ../build-${BUILD_SPEC}-relwithdebinfo/bin/xmilics -n1 -p1 -s all > test_xmilics.out
    - num_xmilics_failed=$( grep -c -e failed -e "did not run correctly" test_xmilics.out ) || true
    - num_failed=$(( $num_mili_failed + $num_xmilics_failed ))
    
.toss4:
  variables:
    SYS_TYPE: toss_4_x86_64_ib

.toss4-intel:
  extends: .toss4
  variables:
    COMPILER_SPEC: intel_classic@2021.6.0
  before_script:
    - module load cmake/3.23.1
    - module load intel-classic/2021.6.0
    - module load python/3.9.12

toss4_intel_slurm_mili:
  stage: test
  tags:
    - rzwhippet
    - slurm
    - batch
  extends:
    - .toss4-intel
    - .slurm-defaults
    - .slurm
    - .build-mili-xmilics
  script:
    - !reference [ .build-mili-xmilics, script ]
    - !reference [ .run-tests, script ]
